trigger: none

resources:
  pipelines:
  - pipeline: BuildPipeline  # Nom de référence pour ce pipeline
    source: build-pipeline   # Nom du pipeline de build dans Azure DevOps
    trigger: 
      branches:
        include:
          - master

pool: "default"

variables:
  resourceGroupName: 'gaal'
  location: 'Canada Central'
  BlobString: 'patate'
  AzureBlob: 'storagegaal'
  AzureFunctionAppName: 'gaaltriggerblob'
  ServiceBusConnectionString: 'ServiceBusConnectionString'
  ServiceBusQueueName: 'ServiceBusQueueName'

stages:
- stage: Infrastructure
  displayName: Infrastructure Deployment
  jobs:
  - job: DeployInfrastructure
    displayName: Deploy Azure Resources
    outputs:
      BlobStorageString: $[ steps.AssignKey.outputs['BlobString'] ]
      ServiceBusConnString: $[ steps.AssignServiceBus.outputs['ServiceBusConnectionString'] ]
      ServiceBusQueue: $[ steps.AssignServiceBus.outputs['ServiceBusQueueName'] ]
    steps:
      - task: AzureResourceManagerTemplateDeployment@3
        displayName: Deploy Azure Storage
        name: StorageDeployment
        inputs:
          deploymentScope: 'Resource Group'
          azureResourceManagerConnection: 'Abonnement_Al(43b74e9f-9d96-4aa0-859d-e36e8ba472b9)'
          subscriptionId: '43b74e9f-9d96-4aa0-859d-e36e8ba472b9'
          action: 'Create Or Update Resource Group'
          resourceGroupName: '$(resourceGroupName)'
          location: '$(location)'
          templateLocation: 'Linked artifact'
          csmFile: '$(System.DefaultWorkingDirectory)/storage/azuredeploy.json'
          csmParametersFile: '$(System.DefaultWorkingDirectory)/storage/azuredeploy.parameters.json'
          deploymentMode: 'Incremental'
          deploymentOutputs: 'StorageOutputs'

      - task: PowerShell@2
        name: AssignKey
        inputs:
          targetType: 'inline'
          script: |
            $outputs = ConvertFrom-Json '$(StorageOutputs)'
            $blobString = $outputs.blobstoragestring.value
            Write-Host "##vso[task.setvariable variable=BlobString;isOutput=true]$blobString"

      - task: AzureResourceManagerTemplateDeployment@3
        displayName: Deploy Function App
        inputs:
          deploymentScope: 'Resource Group'
          azureResourceManagerConnection: 'Abonnement_Al(43b74e9f-9d96-4aa0-859d-e36e8ba472b9)'
          subscriptionId: '43b74e9f-9d96-4aa0-859d-e36e8ba472b9'
          action: 'Create Or Update Resource Group'
          resourceGroupName: '$(resourceGroupName)'
          location: '$(location)'
          templateLocation: 'Linked artifact'
          csmFile: '$(System.DefaultWorkingDirectory)/functionApp/azuredeploy.json'
          csmParametersFile: '$(System.DefaultWorkingDirectory)/functionApp/azuredeploy.parameters.json'
          deploymentMode: 'Incremental'

      - task: AzureResourceManagerTemplateDeployment@3
        displayName: Deploy Service Bus
        name: ServiceBusDeployment
        inputs:
          deploymentScope: 'Resource Group'
          azureResourceManagerConnection: 'Abonnement_Al(43b74e9f-9d96-4aa0-859d-e36e8ba472b9)'
          subscriptionId: '43b74e9f-9d96-4aa0-859d-e36e8ba472b9'
          action: 'Create Or Update Resource Group'
          resourceGroupName: '$(resourceGroupName)'
          location: '$(location)'
          templateLocation: 'Linked artifact'
          csmFile: '$(System.DefaultWorkingDirectory)/serviceBus/azuredeploy.json'
          csmParametersFile: '$(System.DefaultWorkingDirectory)/serviceBus/azuredeploy.parameters.json'
          deploymentMode: 'Incremental'
          deploymentOutputs: 'ServiceBusOutputs'

      - task: PowerShell@2
        name: AssignServiceBus
        inputs:
          targetType: 'inline'
          script: |
            $outputs = ConvertFrom-Json '$(ServiceBusOutputs)'
            $connString = $outputs.ServiceBusConnectionString.value
            $queueName = $outputs.ServiceBusQueueName.value
            Write-Host "##vso[task.setvariable variable=ServiceBusConnectionString;isOutput=true]$connString"
            Write-Host "##vso[task.setvariable variable=ServiceBusQueueName;isOutput=true]$queueName"

- stage: DeployFunctions
  displayName: Deploy Functions
  dependsOn: Infrastructure
  variables:
    blobstring: $[ stageDependencies.Infrastructure.DeployInfrastructure.outputs['AssignKey.BlobString'] ]
    serviceBusConnString: $[ stageDependencies.Infrastructure.DeployInfrastructure.outputs['AssignServiceBus.ServiceBusConnectionString'] ]
    serviceBusQueueName: $[ stageDependencies.Infrastructure.DeployInfrastructure.outputs['AssignServiceBus.ServiceBusQueueName'] ]
  jobs:
  - job: DeployBlobFunction
    displayName: Deploy Blob Function
    steps:
      - download: BuildPipeline
        artifact: blob-function
        
      - task: AzureFunctionApp@2
        displayName: Deploy Blob Function
        inputs:
          connectedServiceNameARM: 'Abonnement_Al(43b74e9f-9d96-4aa0-859d-e36e8ba472b9)'
          appType: 'functionApp'
          appName: '$(AzureFunctionAppName)'
          deployToSlotOrASE: true
          resourceGroupName: '$(resourceGroupName)'
          slotName: 'production'
          package: '$(Pipeline.Workspace)/BuildPipeline/blob-function/**/*.zip'
          appSettings: '-Blob_ConnectionString $(blobstring) -Blob_ConnectionString__blob "https://$(AzureBlob).blob.core.windows.net/"'
          deploymentMethod: 'runFromPackage'

  - job: DeployQueueFunction
    displayName: Deploy Queue Function
    steps:
      - download: BuildPipeline
        artifact: queue-function
        
      - task: AzureFunctionApp@2
        displayName: Deploy Queue Function
        inputs:
          connectedServiceNameARM: 'Abonnement_Al(43b74e9f-9d96-4aa0-859d-e36e8ba472b9)'
          appType: 'functionApp'
          appName: '$(AzureFunctionAppName)'
          deployToSlotOrASE: true
          resourceGroupName: '$(resourceGroupName)'
          slotName: 'production'
          package: '$(Pipeline.Workspace)/BuildPipeline/queue-function/**/*.zip'
          appSettings: |
            -ServiceBus_ConnectionString $(serviceBusConnString)
            -ServiceBus_QueueName $(serviceBusQueueName)
          deploymentMethod: 'auto'